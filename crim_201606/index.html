<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Climate Data Delivery at PCIC</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h1>Climate Data Delivery at PCIC</h1>
					<p>James Hiebert and Basil Veerman</p>
					<p>2016-06-14</p>
					<aside class="notes">
						<ul>
							<li>Thanks for having us!</li>
							<li>Our visit represents the work of others</li>
							<ul>
								<li>2 others in Computational Support Group</li>
								<lI>Another dozen scientific staff at PCIC</lI>
							</ul>
							<li>Thrilled to be here</li>
							<li>Other visits to Montreal were in March</li>
							<li>"Harsh winter reality" after coming from the cherry blossoms of Victoria</li>
						</ul>
					</aside>
				</section>
				<section data-background="images/me.jpg">
					<h2 style="position: relative; top: -200px;">About me</h2>
					<aside class="notes">
						<ul>
							<li>PCIC for 6.5 years</li>
							<li>NOAA before that</li>
						</ul>
						<p>
							When our director, Dr. Francis Zwiers
							gives presentations, he makes liberal use
							of his own photograph and the joke is that
							if you don't enjoy the <em>content</em> of
							the presentation, at least you can try and
							guess where the photos were taken. So I'm
							trying to follow his lead in that
							respect.
						</p>
					</aside>
				</section>
					
				</section>
				<section data-background="images/uvic.jpg">
					<h2 style="position: relative; top: -200px;" >Pacific Climate<br>Impacts Consortium</h2>
					<h3 style="position: relative; top: -100px;" class="fragment">PCIC</h3>

					<aside class="notes">
						<p>
							Basil and I are here visiting from the Pacific Climate
							Impacts Consortium *click* or (PCIC) which
							is a non-profit based out of the
							University of Victoria. Our mission is to
							bridge the gap between academic climate
							science and applied policy regarding the
							impacts of climate change.
						</p>
						<p>
							PCIC was created in 2005, through an
							endowment from the province of BC and
							I <em>believe</em> that we were modeled
							after Ouranos. We are also structured as a
							consortium model, though we have a much
							smaller staff. I think that there are
							around 15 staff members and half a dozen
							research affilliates.
						</p>
					</aside>
				</section>

				<section data-background="images/partners.jpg">

					<aside class="notes">
						<p>
							We work with our partners to conduct
							credible, peer reviewed research on the
							effects of climate change in BC and work
							with stakeholders such as provincial,
							regional and local governments to make use
							of that research.
						</p>
					</aside>
				</section>

				<section data-background="images/glen_canyon_dam.jpg">
					<h2 style="position: relative; top: 50px;" >E.g. hydro power</h2>
					<aside class="notes">
						Our stakeholders use our climate projections
						to answer a wide array of pertinent questions
						and to make policy and engineering descision
						for incredibly expensive infrastructure based
						on the results of our impacts models. Examples
						include whether future river flows can support
						hydro power...
					</aside>
				</section>

				<section data-background="images/road_washout.jpg">
					<h2>E.g. stormwater runoff</h2>
					<aside class="notes">
						whether future storm intensity will
						necessitate larger culverts, storm drains, or
						bridges...
					</aside>
				</section>

				<section data-background="images/storm_surge.jpg">
					<h2>E.g. sea level rise</h2>
					<aside class="notes">
						to what degree sea level rise might inundate
						our homes and farmland...
					</aside>
				</section>

				<section data-background="images/glacier_calve.jpg">
					<h2>E.g. glacier melt</h2>
					<aside class="notes">
						how loss of glacier mass might affect our
						streams and rivers...
					</aside>
				</section>

				<section data-background="images/alpine_glaciers.jpg">
					<h2>E.g. glacier melt</h2>
					<aside class="notes">
						both tidewater and alpine glaciers...
					</aside>
				</section>

				<section data-background="images/forest_fire.jpg">
					<h2>E.g. forest fire</h2>
					<aside class="notes">
						or whether our forests might become more
						susceptible to fire...
					</aside>
				</section>

				<section data-background="images/pine_beetle.jpg">
					<h2>E.g. pine bark beetle</h2>
					<aside class="notes">
						or outbreaks of disease.
					</aside>
				</section>

				<section>
					<h2>Data</h2>
					<img src="images/hydrograph.jpg" />
					<aside class="notes">
						In doing this work, we use and create a wide
						variety of spatio-temporal data: data that's
						distributed across time and space.
					</aside>
				</section>						
				<section>
					<h2>More data</h2>
					<img src="images/prec_overlaid.png" />
				</section>
				<section>
					<h2>Yet more data</h2>
					<img src="images/random_map.png" />
				</section>
				<section>
					<h4>You know where this is going</h4>
					<img src="images/climdex.jpg" />
					<aside class="notes">
						Keeping in line with our service model, we
						have a responsibility to share and publish
						that data to our users and stakeholders which
						could be anyone from government scientists, to
						hydro power engineers, to municipal planners.
					</aside>
				</section>
						

				<section>
					<h2>Our Products</h2>
					<iframe width="1024" height="600" frameborder="0"
							scrolling="yes" marginheight="0" marginwidth="0"
							src="https://pacificclimate.org/data/"
							style="border: 1px solid black; background-color: white"></iframe>
					<aside class="notes">
						<p>
							So over the last five years or so, we have
							created a suite of data server
							applications that researchers and
							affilliates can use to self-serve data
							according to their needs.
						</p>
						<ul>
							<li>Aggregated weather data</li>
							<li>High-resolution downscaled climate model output</li>
							<li>Gridded hydrologic model output</li>
							<li>Discrete hydrologic model output</li>
						</ul>
					</aside>
				</section>
				<section data-background="images/Holland_Island_house.jpg">
					<div style="position: relative; bottom: 200px;">
						<h2>The Problem</h2>
					</div>
					<p style="position: relative; top: 250px;">
						<small>
							"<a href="http://commons.wikimedia.org/wiki/File:Holland_Island_house.jpg#mediaviewer/File:Holland_Island_house.jpg">Holland
							Island house</a>" by Flickr
							User <a rel="nofollow" class="external
							text"
							href="http://www.flickr.com/photos/baldeaglebluff/">baldeaglebluff</a>.<br>Licensed
							under <a title="Creative Commons
							Attribution-Share Alike 2.0"
							href="http://creativecommons.org/licenses/by-sa/2.0">CC
							BY-SA 2.0</a>
							via <a href="//commons.wikimedia.org/wiki/">Wikimedia
							Commons</a>
						</small>
					</p>
					<aside class="notes">
						<p>
							But it wasn't always as easy for us to
							serve up data as it is now, so let me
							discuss how the need for data distribution
							came about and then I'll talk about how we
							solved the problem.
						</p>
					</aside>
				</section>
				<section data-background="images/conference.jpg">
					<aside class="notes">
						We'd have one of our team leads go to a
						conference or meeting and extoll the virtues
						of all of the great work that we had done, and
						the volumes of climate data that we have.
					</aside>
				</section>
				<section data-background="images/handshake-reverse.jpg">
					<aside class="notes">
						Inevitably we'd make some connections with
						other researchers and they'd say:
					</aside>
				</section>
				<section data-background="images/handshake-collaborate.png">
					<aside class="notes">
						"You know, we should really collaborate."
					</aside>
				</section>
				<section data-background="images/handshake-data-please.png">
					<aside class="notes">
						"I'd love to take a look at some of your
						results. Can you send me your data?"
					</aside>
				</section>
				<section data-background="images/two-person-computer.jpg">
					<aside class="notes">
						So our lead research comes home from the
						conference energized and motivated and wants
						to follow up on their committments, gets one
						of our research staff as says, "Hey can you
						help me deliver our data to this other
						researcher that I met?"
					</aside>
				</section>
				<section data-background="images/hard-drive-pile.jpg">
					<aside class="notes">
						But it turns out that it's hard to do. We have
						around 200 TB of climate model output, and you
						can't just send that in an e-mail attachment.
					</aside>
				</section>
				<section data-background="images/three-person-computer.jpg">
					<aside class="notes">
						So they come and grab me, the Lead of
						Computational Support and ask for some help
						getting the data to this other researcher. So
						I say, "Sure that sounds like a valuable
						collaboration." So I go and get our System
						Administrator and say...
					</aside>
				</section>
				<section data-background="images/four-person-computer.jpg">
					<aside class="notes">
						<p>
							"Hey Steve, can you help me get this data
							to this external collaborator?" All of a
							sudden, we have four of us a PCIC, nearly a
							3rd of our staff, coordinating, sending
							e-mails, and losing our day on releasing a
							single dataset to a single person.
						</p>
						<p>
							The situation was clearly untenable, and
							couldn't scale. What if multiple people
							wanted our data, or dozens, or hundreds?
							Were we going to dedicate our entire staff
							resources to data distribution? Obviously
							not, so we set out to fix the problem with
							a technical solution.
						</p>
					</aside>
				</section>
				<section data-background="images/jellyfish.jpg">
					<h2>Our strategy</h2>
					<ul>
						<li>Small team!</li>
						<li>Leverage Open Source Software</li>
						<li>Contribute to Open Source Software</li>
					</ul>
					<aside class="notes">
						<p>
							We have a very small dev team... there are
							only four of us who have computer science
							backgrounds. One is our system administrator
							and doesn't code, and I'm the supervisor and
							theorettically wouldn't have to code unless it
							wasn't so much fun. So realistically we only
							have about 1.5-2 FTE dedicated to our web
							services development.
						</p>
						<p>
							With a small group, we have to make use of
							what public resources are available, so we
							heavily leverage open source software. Pretty
							much everything that we do is built on top of
							open source software.
						</p>
						<p>
							But we also make strategic investments in
							open source as well. We occasionally
							attend code sprints for the projects that
							we utilize, we have published a selection
							R packages on the R package repository,
							and we've taken over maintainence for a
							project call PyDAP that is an open source
							data server. These investments ensure that
							other members of the community don't have
							to duplicate the work that we've already
							done, and hopefully that will free up
							others to solve problems that we might
							benefit from down the road.
						</p>
					</aside>
				</section>
				<section>
					<h2>"Provincial Climate Data Set"</h2>
					<iframe width="1024" height="600" frameborder="0"
							scrolling="yes" marginheight="0" marginwidth="0"
							src="http://tools.pacificclimate.org/dataportal/pcds/map/"
							style="border: 1px solid black; background-color: white"></iframe>
					<aside class="notes">
						<p>
							Our first shot at data distribution was
							4-5 years ago working with a group of
							natural resource managers for the province
							of BC. They were all collecting weather
							data for their own particular needs (for
							example avalanche monitoring or forest
							fire monitoring), but were frustrated with
							not having access to the station data in
							someone else's ministry.
						</p>
						<p>
							So we stepped in and joined them and said,
							"Hey, if you all work to give PCIC your
							historic data and continue streaming it to
							us, we can make it available to everyone,
							and maintain the data in perpetuity for
							long-term climate monitoring.
						</p>
					</aside>
				</section>
				<section data-background="images/ec_weather_station.jpg">
					<aside class="notes">
						<p>
							This project had some attributes that made
							it good for our first attempt at data
							distribution.
						</p>
						<p>
							The data come from discrete locations and
							are taken at discrete time intervals. And
							unlike climate model output, there's no
							future data... only the past. So
							ultimately the data lacks bulk; the entire
							data set fits on a 1-2 TB hard drive,
							which makes it much easier to build a
							system around.
						</p>
					</aside>
				</section>
				<section data-background="images/wind.jpg">
					<aside class="notes">
						A downside, however, is that the data is
						highly heterogeneous. Each location has
						multiple sensors, but stations have different
						sets of sensors.
					</aside>
				</section>
				<section data-background="images/rain.jpg">
					<aside class="notes">
						And stations all have different temporal
						properties. They may only operate
						intermittently, certain times of the year,
						they might include time ranges were sensors
						were manually read by humans and then
						transcribed, so there's a lot of variation
						throughout the dataset.
					</aside>
				</section>
				<section data-background="images/ec_weather_station_2.jpg">
					<h2 style="position: relative; top: -150px;">PCDS Portal</h2>
					<ul style="position: relative; top: -150px; right: -50px">
						<li>Low bulk (+)</li>
						<ul>
							<li>discrete locations</li>
							<li>discrete times</li>
							<li>no future data (hopefully)</li>
						</ul>
						<li>Highly hetergeneous (-)</li>
					</ul>
				</section>
				<section>
					<object width="1024" height="768" data="images/pcds_arch.pdf"></object>
					<aside class="notes">
						<ul>
							<li>PostgreSQL/PostGIS for persistence</li>
							<li>Geoserver for feature layers</li>
							<li>Python backend for a handful of API endpoints</li>
							<li>PyDAP serves the timeseries data in a handful of different formats</li>
						</ul>
					</aside>
				</section>
				<section data-background="images/river.jpg">
					<aside class="notes">
						<ul>
							<li>We have a team of hydrologists</li>
							<li>They run hydrologic simulations under climate change scenarios</li>
							<li>One output is a timeseries of future flow at gauged locations</li>
							<li>So we created a data portal to distribute their data</li>
						</ul>
					</aside>
				</section>
				<section>
					<h2>Hydrologic routed flow</h2>
					<iframe width="1024" height="600" frameborder="0"
							scrolling="yes" marginheight="0" marginwidth="0"
							src="http://tools.pacificclimate.org/dataportal/hydro_stn/map/"
							style="border: 1px solid black; background-color: white"></iframe>
					<aside class="notes">
						<ul>
							<li>Discrete locations</li>
							<li>Only one variable (flow)</li>
							<li>Time vs. location vs. emission scenario</li>
							<li>Single map</li>
							<li>Pydap serves files from disk</li>
							<li>Essentially a glorified HTTP index page</li>
						</ul>
					</aside>
				</section>
				<section data-background="images/engineering.jpg">
					<h2>Raster Portal(s)</h2>
					<aside class="notes">
						This was our biggest engineering challeng
					</aside>
				</section>
				
				<section>
					<h2>Spatiotemporal data</h2>
					<h3>i.e. the "Data Cube"</h3>
					<img src="images/data_cube.png" />
					<aside class="notes">
						<p>
							Most of our climate data are
							"spatiotemporal" data, so it has values
							distributed across time and space.
						</p>
					</aside>
				</section>
				<section data-background="images/downscaled_gcms.png">
					<aside class="notes">
						<p>
							Some of our bigger datasets are 10km,
							Canada-wide, downscaled GCMs. They contain
							daily data from 1950-2100, so the biggest
							files are around 170 GB each.
						</p>
						<p>
							Really, most of our users are only
							interested in a spatial or temporal subset
							of that data... they want a "hyperslab",
							so it would be bad to make them download
							the whole thing, only to have them pare it
							down to a fraction of its size on their
							end.
						</p>
					</aside>
				</section>
				<section>
					<h2>Raster Portals' Components</h2>
					<object type="image/svg+xml"
							data="images/raster_portal_layers.svg">
						SVG drawing of raster portal architecture
					</object>
					<aside class="notes">
						<p>
							So we built a system that used the OpENDAP
							protocol at its core. OPeNDAP is a
							protocol built over HTTP that describes
							how to select and transfer datasets or
							subsets thereof.
						</p>
						<p>
							We took the PyDAP OPeNDAP server, hacked a
							fork of it and extended it to use
							generators, an asyncronous programming
							technique that allows us to stream the
							HTTP response, while simultaneously
							reading and processing the large NetCDF
							data files.
						</p>
					</aside>
				</section>
				<section data-background="images/baker.jpg">
					<h2>Big data, big RAM, BadRequest, Oh My!</h2>
					<img src="images/opendap_form.png" />
					<aside class="notes">
						<p>
							Most OPeNDAP servers out there like
							THREDDS, just set a request size limit that is
							well below the available system RAM.
						</p>
					</aside>
				</section>
				<section data-background="images/baker.jpg">
					<h2>Big data, big RAM, BadRequest, Oh My!</h2>
					<img src="images/bad_request.png" />
					<aside class="notes">
						<p>
						But that was a *really* small fraction of our
						dataset size, and we didn't want for our
						users to have to go through the
						inconvenience of splitting their data
						request across thousands of separate
						requests.
					</p>
				</section>
				<section data-background="images/volcano.jpg">
					<h2>Generators: 70's tech that works today!</h2>
					<ul>
						<li>a function which yields execution rather than returning</li>
						<li>yields values one at a time, on-demand</li>
						<li>low memory footprint</li>
						<li>faster; no calling overhead</li>
						<li>elegant!</li>
					</ul>
					<aside class="notes">
						<p>
							Enter generators and
							coroutines. Generators are a programming
							control where a function, rather than
							returning, can yield execution and sort of
							return values one at a time on-demand. It
							has the performance advantage of
							maintaining a low memory footprint, if you
							want to return something large, you don't
							have to do so all at once, and they tend
							to be slightly faster, because you avoid a
							lot of calling overhead of stack
							manipulation.
						</p>
						<p>
							Generators have been around for a good
							thirty-five years, but have been
							experiencing a bit of a Renaissance
							lately. If one programs in python, they
							are extremely easy to use, and with the
							advent of big data applications, they have
							a lot of utility.
						</p>
					</aside>
				</section>
				<section data-background="images/volcano.jpg">
					<h2>Generator Example</h2>
					<pre>
from itertools import islice
def fibonacci():
    a, b = 0, 1
    while True:
        yield a
        a, b = b, a+b

# print the first 10 values of the fibonacci sequence
for x in islice(fibonacci(), 10):
    print x
					</pre>
					<aside class="notes">
						<p>
							For those who aren't familiar, here's a
							quick example to understand
							generators. Generating a Fibonacci
							sequence is kind of the quintessential toy
							example. The generator function,
							fibonacci(), is defined at the top. You'll
							notice that it's an infinite loop, because
							the sequence is by definition,
							infinite. But rather than building up the
							values in memory, it just has a simple and
							elegant “yield” statement right inside the
							loop. The calling loop down below,
							actually pulls items from the function,
							one at a time, and then does whatever it
							needs to do with them. It's fast,
							efficient, and actually fairly elegant,
							readable code, too.
						</p>
						<p>
							So you can see, for something like a web
							application serving big datasets, this is
							perfect, because we can provide a very low
							latency response, and then stream the data
							to the user as our high-latency operations
							like disk reads take place.
						</p>
						<p>
							None of the OPeNDAP servers out there
							supported streaming, so many of the
							modifications that we made to PyDAP were
							for it to use generators to stream the
							responses.
						</p>
					</aside>
				</section>
				
				<section data-background="images/five-alarm-fire.jpg">
					<h2>Problems?</h2>
					<ul>
						<li>One process / HTTP request</li>
						<li>Requests are long lived</li>
						<li>Errors can happen mid-transmission</li>
						<li>PyDAP doesn't support HTTP Partial Content</li>
					</ul>
				</section>
				<section>
					<iframe width="1024" height="600" frameborder="0"
							scrolling="yes" marginheight="0" marginwidth="0"
							src="http://tools.pacificclimate.org/dataportal/bc_prism/map/"
							style="border: 1px solid black; background-color: white"></iframe>
				</section>
				<section>
					<h2>Challenges</h2>
					<ul>
						<li>DATA BULK!</li>
						<li>One man open source projects</li>
						<li>Single organization "open source" projects</li>
					</ul>
					<aside class="notes">
						<p>
						</p>
					</aside>
				</section>
				
				<section>
					<h2>The future?</h2>
					<ul>
						<li>Information, not data</li>
						<li>Online analysis saves bandwidth</li>
					</ul>
					<aside class="notes">
					</aside>
				</section>
				<section>
					<h2>PCIC Climate Explorer</h2>
					<iframe width="1024" height="600" frameborder="0"
							scrolling="yes" marginheight="0" marginwidth="0"
							src="http://docker1.pcic.uvic.ca:20002/"
							style="border: 1px solid black; background-color: white"></iframe>						
				</section>
				<section>
					<h2>Conclusions</h2>
					
					<aside class="notes">
					</aside>
				</section>
				<section>
					<h2>Spatiotemporal data</h2>
					<h3>i.e. the "Data Cube"</h3>
					<p>Content</p>
					<ul>
						<li>Bulletted</li>
						<li>List</li>
					</ul>
					<aside class="notes">
						Notes, notes and more notes
					</aside>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
			{ src: 'plugin/notes/notes.js', async: true },
			{ src: 'socket.io/socket.io.js', async: true },
			{ src: 'plugin/notes-server/client.js', async: true},
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
